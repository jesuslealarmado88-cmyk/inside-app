<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="theme-color" content="#07090d">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<title>inside</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Syne:wght@700;800&family=Mulish:ital,wght@0,400;0,500;0,600;1,400&display=swap" rel="stylesheet">
<style>
:root {
  --void:    #07090d;
  --deep:    #0d1117;
  --surface: #141c26;
  --elev:    #1b2535;
  --border:  rgba(255,255,255,0.07);
  --accent:  #e2ff5d;
  --mine:    #1d4ed8;
  --theirs:  #1b2535;
  --text:    #dde6f0;
  --muted:   #55617a;
  --green:   #4ade80;
  --danger:  #ff5555;
  --f1: 'Syne', sans-serif;
  --f2: 'Mulish', sans-serif;
  --ease: cubic-bezier(.4,0,.2,1);
}
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
html, body {
  height: 100%; height: 100dvh;
  overflow: hidden;
  background: var(--void);
  font-family: var(--f2);
  color: var(--text);
  -webkit-font-smoothing: antialiased;
  -webkit-tap-highlight-color: transparent;
}
button { cursor: pointer; border: none; background: none; font-family: inherit; }
input, textarea { font-family: inherit; }

/* â”€â”€ SCREENS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.screen {
  position: fixed; inset: 0;
  display: flex; flex-direction: column;
  transition: opacity .3s, transform .3s var(--ease);
}
.screen.off { opacity: 0; pointer-events: none; transform: scale(.97); }

/* â”€â”€ ENTER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
#s-enter {
  align-items: center;
  justify-content: center;
  overflow-y: auto;
  padding: 24px 16px;
}

.blob {
  position: fixed; border-radius: 50%;
  filter: blur(90px); pointer-events: none;
  animation: drift 14s ease-in-out infinite alternate;
}
.b1 { width: 500px; height: 500px; background: radial-gradient(circle, rgba(226,255,93,.06) 0%, transparent 70%); top: -200px; right: -120px; }
.b2 { width: 380px; height: 380px; background: radial-gradient(circle, rgba(93,255,204,.05) 0%, transparent 70%); bottom: -140px; left: -80px; animation-delay: -7s; }
@keyframes drift { from { transform: translate(0,0); } to { transform: translate(22px,16px); } }

.card {
  width: 100%;
  max-width: 400px;
  background: var(--deep);
  border: 1px solid var(--border);
  border-radius: 24px;
  padding: 32px 28px;
  position: relative; z-index: 1;
  box-shadow: 0 24px 60px rgba(0,0,0,.5);
  animation: cardIn .5s cubic-bezier(.16,1,.3,1) both;
}
@keyframes cardIn { from { opacity:0; transform: translateY(32px); } to { opacity:1; transform: none; } }

.logo { display: flex; align-items: center; gap: 10px; margin-bottom: 30px; }
.lmark {
  width: 42px; height: 42px; border-radius: 12px;
  background: var(--accent);
  display: flex; align-items: center; justify-content: center;
  flex-shrink: 0; position: relative; overflow: hidden;
}
.lmark::before { content: ''; position: absolute; inset: 0; background: linear-gradient(135deg, rgba(255,255,255,.25) 0%, transparent 55%); }
.lmark svg { width: 22px; height: 22px; fill: var(--void); position: relative; }
.lname { font-family: var(--f1); font-size: 26px; font-weight: 800; letter-spacing: -1px; color: #fff; }

.etitle { font-family: var(--f1); font-size: 22px; font-weight: 700; letter-spacing: -.3px; margin-bottom: 6px; }
.esub { font-size: 13px; color: var(--muted); margin-bottom: 26px; line-height: 1.6; }

.flabel { font-size: 10px; font-weight: 700; letter-spacing: 1px; text-transform: uppercase; color: var(--muted); margin-bottom: 7px; display: block; }
.finput {
  width: 100%; background: var(--surface);
  border: 1.5px solid var(--border); border-radius: 12px;
  padding: 12px 15px; font-size: 15px; color: var(--text);
  outline: none; -webkit-appearance: none;
  transition: border-color .2s, box-shadow .2s;
}
.finput:focus { border-color: rgba(226,255,93,.4); box-shadow: 0 0 0 3px rgba(226,255,93,.07); }
.finput::placeholder { color: var(--muted); opacity: .55; }
.finput.err { border-color: rgba(255,85,85,.5); animation: shake .35s ease; }
.field { margin-bottom: 16px; }

/* PIN GRID â€” fixed, never overflows */
.pin-grid {
  display: grid;
  grid-template-columns: repeat(6, 1fr);
  gap: 7px;
  width: 100%;
}
.pdig {
  width: 100%;
  min-width: 0;
  height: 52px;
  background: var(--surface);
  border: 1.5px solid var(--border);
  border-radius: 10px;
  font-family: var(--f1);
  font-size: 20px;
  font-weight: 700;
  color: var(--text);
  text-align: center;
  outline: none;
  -webkit-appearance: none;
  padding: 0;
  transition: border-color .18s, box-shadow .18s;
  caret-color: var(--accent);
}
.pdig:focus { border-color: rgba(226,255,93,.5); box-shadow: 0 0 0 3px rgba(226,255,93,.08); }
.pdig.has { border-color: rgba(226,255,93,.3); color: var(--accent); }
.pdig.err { border-color: var(--danger); animation: shake .35s ease; }
@keyframes shake { 0%,100%{transform:none} 25%{transform:translateX(-6px)} 75%{transform:translateX(6px)} }

.errmsg { font-size: 12px; color: var(--danger); margin-top: 7px; display: none; }
.errmsg.show { display: block; }

.btn-go {
  width: 100%; margin-top: 22px; padding: 14px;
  background: var(--accent); color: var(--void);
  font-family: var(--f1); font-weight: 700; font-size: 15px;
  border-radius: 12px; position: relative; overflow: hidden;
  transition: transform .18s, box-shadow .18s;
}
.btn-go::before { content: ''; position: absolute; inset: 0; background: linear-gradient(135deg, rgba(255,255,255,.2) 0%, transparent 50%); pointer-events: none; }
.btn-go:hover { transform: translateY(-2px); box-shadow: 0 10px 26px rgba(226,255,93,.2); }
.btn-go:active { transform: scale(.97); }
.btn-go:disabled { opacity: .45; cursor: not-allowed; transform: none; box-shadow: none; }
.bspin { display: none; width: 18px; height: 18px; border: 2px solid rgba(0,0,0,.2); border-top-color: var(--void); border-radius: 50%; animation: spin .65s linear infinite; margin: 0 auto; }
@keyframes spin { to { transform: rotate(360deg); } }
.btn-go.loading .btxt { display: none; }
.btn-go.loading .bspin { display: block; }

/* â”€â”€ MAIN â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
#s-main { background: var(--void); }

.topbar {
  display: flex; align-items: center; gap: 12px;
  padding: 10px 14px;
  background: var(--deep); border-bottom: 1px solid var(--border);
  flex-shrink: 0; min-height: 60px; z-index: 10;
}
.tav {
  width: 40px; height: 40px; border-radius: 50%; flex-shrink: 0;
  background: linear-gradient(135deg, var(--accent) 0%, #5dffcc 100%);
  display: flex; align-items: center; justify-content: center;
  font-family: var(--f1); font-weight: 800; font-size: 17px; color: var(--void);
  position: relative;
}
.odot { position: absolute; bottom: 0; right: 0; width: 11px; height: 11px; background: var(--green); border: 2px solid var(--deep); border-radius: 50%; display: none; }
.odot.on { display: block; }
.tinfo { flex: 1; min-width: 0; }
.tname { font-family: var(--f1); font-size: 15px; font-weight: 700; letter-spacing: -.2px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.tstatus { font-size: 11.5px; color: var(--muted); margin-top: 1px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; transition: color .3s; }
.tstatus.on { color: var(--green); }
.tbadge {
  background: rgba(226,255,93,.08); border: 1px solid rgba(226,255,93,.18);
  border-radius: 20px; padding: 5px 11px;
  font-size: 11px; font-weight: 600; color: var(--accent);
  white-space: nowrap; flex-shrink: 0;
}
@media (max-width: 360px) { .tbadge { display: none; } }

#msgs {
  flex: 1; overflow-y: auto; overflow-x: hidden;
  padding: 10px 0 2px;
  display: flex; flex-direction: column;
  background-image: radial-gradient(rgba(255,255,255,.03) 1px, transparent 1px);
  background-size: 28px 28px;
}
#msgs::-webkit-scrollbar { width: 3px; }
#msgs::-webkit-scrollbar-thumb { background: rgba(255,255,255,.07); border-radius: 3px; }

.empty {
  display: flex; flex-direction: column; align-items: center; justify-content: center;
  flex: 1; gap: 12px; padding: 40px 24px; pointer-events: none;
}
.eicon { width: 68px; height: 68px; background: var(--surface); border: 1px solid var(--border); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 28px; }
.empty p { font-size: 13px; color: var(--muted); text-align: center; line-height: 1.65; max-width: 200px; }

.dsep { display: flex; align-items: center; justify-content: center; padding: 10px 16px; gap: 8px; }
.dsep::before, .dsep::after { content: ''; flex: 1; height: 1px; background: var(--border); }
.dsep span { font-size: 10px; color: var(--muted); font-weight: 700; letter-spacing: .5px; text-transform: uppercase; white-space: nowrap; }

.mrow {
  display: flex; padding: 2px 12px;
  opacity: 0; transform: translateY(8px);
  transition: opacity .24s, transform .24s cubic-bezier(.16,1,.3,1);
}
.mrow.in { opacity: 1; transform: none; }
.mrow.mine { justify-content: flex-end; }
.mrow.theirs { justify-content: flex-start; }
.mrow.mine + .mrow.mine,
.mrow.theirs + .mrow.theirs { padding-top: 1px; }

.bub {
  max-width: min(72%, 420px);
  padding: 9px 13px 7px;
  border-radius: 18px;
  word-break: break-word;
  line-height: 1.48; font-size: 14.5px;
  white-space: pre-wrap;
}
.mrow.mine .bub { background: var(--mine); color: #fff; border-bottom-right-radius: 4px; }
.mrow.theirs .bub { background: var(--theirs); color: var(--text); border: 1px solid rgba(255,255,255,.06); border-bottom-left-radius: 4px; }

.bsender { display: block; font-size: 11px; font-weight: 700; color: var(--accent); margin-bottom: 3px; }
.mrow.mine .bsender { display: none; }
.btext a { text-decoration: underline; opacity: .8; }
.bmeta { display: flex; align-items: center; justify-content: flex-end; gap: 4px; margin-top: 4px; }
.btime { font-size: 10px; opacity: .45; font-weight: 500; }
.btick { display: flex; }
.btick svg { width: 14px; height: 14px; fill: rgba(255,255,255,.45); }

#tybar { padding: 2px 18px 0; min-height: 22px; flex-shrink: 0; }
.tyinner { display: flex; align-items: center; gap: 8px; opacity: 0; transform: translateY(4px); transition: opacity .2s, transform .2s; }
.tyinner.on { opacity: 1; transform: none; }
.tydots { display: flex; gap: 3px; }
.tydots span { width: 5px; height: 5px; background: var(--muted); border-radius: 50%; animation: dotb 1.2s infinite; }
.tydots span:nth-child(2) { animation-delay: .2s; }
.tydots span:nth-child(3) { animation-delay: .4s; }
@keyframes dotb { 0%,60%,100%{transform:none;opacity:.35} 30%{transform:translateY(-4px);opacity:1} }
.tylabel { font-size: 11.5px; color: var(--muted); font-style: italic; }

.ibar {
  display: flex; align-items: flex-end; gap: 9px;
  padding: 9px 11px;
  background: var(--deep); border-top: 1px solid var(--border);
  flex-shrink: 0;
}
@supports (padding-bottom: env(safe-area-inset-bottom)) {
  .ibar { padding-bottom: calc(9px + env(safe-area-inset-bottom)); }
}
#inp {
  flex: 1; background: var(--surface);
  border: 1.5px solid var(--border); border-radius: 22px;
  padding: 11px 17px; font-size: 14.5px; color: var(--text);
  outline: none; resize: none;
  max-height: 130px; min-height: 46px; line-height: 1.44;
  transition: border-color .2s; -webkit-appearance: none;
}
#inp:focus { border-color: rgba(226,255,93,.3); }
#inp::placeholder { color: var(--muted); opacity: .45; }
#bsend {
  width: 46px; height: 46px; background: var(--accent);
  border-radius: 50%; display: flex; align-items: center; justify-content: center;
  flex-shrink: 0; opacity: .35;
  transition: opacity .2s, transform .18s, box-shadow .18s;
}
#bsend.on { opacity: 1; }
#bsend.on:hover { transform: scale(1.09); box-shadow: 0 5px 18px rgba(226,255,93,.28); }
#bsend.on:active { transform: scale(.92); }
#bsend svg { width: 20px; height: 20px; fill: var(--void); margin-left: 2px; }

/* Connecting overlay */
#overlay {
  position: fixed; inset: 0;
  background: rgba(7,9,13,.88); backdrop-filter: blur(8px);
  z-index: 100; display: flex; flex-direction: column;
  align-items: center; justify-content: center; gap: 14px;
  transition: opacity .3s;
}
#overlay.gone { opacity: 0; pointer-events: none; }
.ospin { width: 34px; height: 34px; border: 3px solid rgba(226,255,93,.18); border-top-color: var(--accent); border-radius: 50%; animation: spin .7s linear infinite; }
#overlay p { font-size: 13px; color: var(--muted); }

/* Toasts */
#toasts { position: fixed; top: 14px; left: 50%; transform: translateX(-50%); z-index: 9999; display: flex; flex-direction: column; gap: 8px; pointer-events: none; width: min(320px, 88vw); }
.toast { background: var(--elev); border: 1px solid var(--border); border-radius: 12px; padding: 11px 15px; font-size: 13px; box-shadow: 0 8px 28px rgba(0,0,0,.4); animation: tin .3s cubic-bezier(.16,1,.3,1), tout .3s ease 2.7s forwards; }
.toast.err { border-color: rgba(255,85,85,.3); color: #ff9090; }
@keyframes tin { from { opacity:0; transform: translateY(-10px) scale(.95); } to { opacity:1; transform: none; } }
@keyframes tout { to { opacity:0; transform: translateY(-8px); } }

@media (min-width: 680px) {
  #s-main { max-width: 640px; margin: 0 auto; border-left: 1px solid var(--border); border-right: 1px solid var(--border); }
  body { background: #040608; }
}
</style>
</head>
<body>

<!-- ENTER -->
<div id="s-enter" class="screen">
  <div class="blob b1"></div>
  <div class="blob b2"></div>
  <div class="card">
    <div class="logo">
      <div class="lmark">
        <svg viewBox="0 0 24 24"><path d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2z"/></svg>
      </div>
      <span class="lname">inside</span>
    </div>
    <h1 class="etitle">Tu espacio privado</h1>
    <p class="esub">Mismo cÃ³digo de 6 dÃ­gitos = misma sala. Sin registro ni correo.</p>

    <div class="field">
      <label class="flabel" for="iname">Tu nombre</label>
      <input id="iname" class="finput" type="text" placeholder="Â¿CÃ³mo te llamas?" maxlength="22" autocomplete="off" autocorrect="off" spellcheck="false">
    </div>

    <div class="field">
      <label class="flabel">CÃ³digo de sala â€” 6 dÃ­gitos</label>
      <div class="pin-grid" id="pingrid">
        <input class="pdig" type="tel" maxlength="1" inputmode="numeric" pattern="[0-9]">
        <input class="pdig" type="tel" maxlength="1" inputmode="numeric" pattern="[0-9]">
        <input class="pdig" type="tel" maxlength="1" inputmode="numeric" pattern="[0-9]">
        <input class="pdig" type="tel" maxlength="1" inputmode="numeric" pattern="[0-9]">
        <input class="pdig" type="tel" maxlength="1" inputmode="numeric" pattern="[0-9]">
        <input class="pdig" type="tel" maxlength="1" inputmode="numeric" pattern="[0-9]">
      </div>
      <div class="errmsg" id="perr">El cÃ³digo debe tener 6 dÃ­gitos</div>
    </div>

    <button class="btn-go" id="bgo" onclick="doEnter()" disabled>
      <span class="btxt">Entrar â†’</span>
      <div class="bspin"></div>
    </button>
  </div>
</div>

<!-- MAIN -->
<div id="s-main" class="screen off">
  <div id="overlay">
    <div class="ospin"></div>
    <p id="overlay-msg">Conectando...</p>
  </div>

  <div class="topbar">
    <div class="tav">
      <span id="tletter">?</span>
      <div class="odot" id="odot"></div>
    </div>
    <div class="tinfo">
      <div class="tname" id="tname">â€”</div>
      <div class="tstatus" id="tstatus">Conectando...</div>
    </div>
    <div class="tbadge" id="tbadge">TÃº</div>
  </div>

  <div id="msgs">
    <div class="empty" id="empty">
      <div class="eicon">ðŸ”’</div>
      <p>Solo quien tenga el cÃ³digo puede ver estos mensajes</p>
    </div>
  </div>

  <div id="tybar">
    <div class="tyinner" id="tyinner">
      <div class="tydots"><span></span><span></span><span></span></div>
      <span class="tylabel" id="tylabel">escribiendo...</span>
    </div>
  </div>

  <div class="ibar">
    <textarea id="inp" placeholder="Escribe algo..." rows="1"></textarea>
    <button id="bsend" onclick="sendMsg()">
      <svg viewBox="0 0 24 24"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/></svg>
    </button>
  </div>
</div>

<div id="toasts"></div>

<script>
// â”€â”€ State â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let ME = '', ROOM = '';
let ws = null;
let lastDate = '';
let typingOut;
let focused = true;
let unread = 0;
let reconnectTimer;
let reconnects = 0;

window.addEventListener('focus', () => { focused = true; unread = 0; document.title = 'inside'; });
window.addEventListener('blur',  () => { focused = false; });

// â”€â”€ Utils â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function safe(s) { const d = document.createElement('div'); d.textContent = s; return d.innerHTML; }
function linkify(t) { return safe(t).replace(/(https?:\/\/[^\s<]+)/g,'<a href="$1" target="_blank" rel="noopener">$1</a>'); }
function fmtTime(ts) { return new Date(ts||Date.now()).toLocaleTimeString('es',{hour:'2-digit',minute:'2-digit'}); }
function fmtDate(ts) {
  const d = new Date(ts||Date.now());
  const today = new Date();
  const diff = Math.floor((new Date(today.toDateString()) - new Date(d.toDateString())) / 86400000);
  if (diff === 0) return 'Hoy';
  if (diff === 1) return 'Ayer';
  return d.toLocaleDateString('es',{weekday:'long',day:'numeric',month:'long'});
}
function toast(msg, type='') {
  const w = document.getElementById('toasts');
  const t = document.createElement('div');
  t.className = 'toast' + (type ? ' '+type : '');
  t.textContent = msg;
  w.appendChild(t);
  setTimeout(() => t.remove(), 3200);
}

// â”€â”€ PIN logic â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const digits = document.querySelectorAll('.pdig');
digits.forEach((d, i) => {
  d.addEventListener('input', e => {
    e.target.value = e.target.value.replace(/\D/g,'').slice(-1);
    if (e.target.value && i < 5) digits[i+1].focus();
    refreshBtn();
  });
  d.addEventListener('keydown', e => {
    if (e.key === 'Backspace' && !e.target.value && i > 0) {
      digits[i-1].value = ''; digits[i-1].focus(); refreshBtn();
    }
    if (e.key === 'Enter') doEnter();
  });
  d.addEventListener('paste', e => {
    e.preventDefault();
    const p = (e.clipboardData||window.clipboardData).getData('text').replace(/\D/g,'').slice(0,6);
    p.split('').forEach((c,j) => { if(digits[j]) { digits[j].value=c; digits[j].classList.toggle('has',true); }});
    digits[Math.min(p.length,5)].focus();
    refreshBtn();
  });
});
function getPin() { return [...digits].map(d=>d.value).join(''); }
function refreshBtn() {
  [...digits].forEach(d => d.classList.toggle('has', !!d.value));
  document.getElementById('bgo').disabled = getPin().length < 6 || !document.getElementById('iname').value.trim();
}
function pinShake() {
  digits.forEach(d => { d.classList.add('err'); setTimeout(()=>d.classList.remove('err'),500); });
  const pe = document.getElementById('perr');
  pe.classList.add('show');
  setTimeout(() => pe.classList.remove('show'), 1500);
}

document.getElementById('iname').addEventListener('input', refreshBtn);
document.getElementById('iname').addEventListener('keydown', e => {
  if (e.key === 'Enter') { e.preventDefault(); digits[0].focus(); }
});

// â”€â”€ Enter handler â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function doEnter() {
  const name = document.getElementById('iname').value.trim();
  const pin  = getPin();
  if (!name) { const n=document.getElementById('iname'); n.classList.add('err'); n.focus(); setTimeout(()=>n.classList.remove('err'),500); return; }
  if (pin.length < 6) { pinShake(); return; }
  ME = name; ROOM = pin;

  const btn = document.getElementById('bgo');
  btn.classList.add('loading'); btn.disabled = true;

  document.getElementById('s-enter').classList.add('off');
  document.getElementById('s-main').classList.remove('off');
  document.getElementById('tletter').textContent = ROOM[0];
  document.getElementById('tname').textContent = 'Sala ' + ROOM;
  document.getElementById('tbadge').textContent = ME;

  connectWS();
  setupInput();
}

// â”€â”€ WebSocket â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function connectWS() {
  const proto = location.protocol === 'https:' ? 'wss:' : 'ws:';
  const url   = proto + '//' + location.host;

  setOverlay(true, reconnects > 0 ? 'Reconectando...' : 'Conectando...');

  ws = new WebSocket(url);

  ws.onopen = () => {
    reconnects = 0;
    ws.send(JSON.stringify({ type: 'join', name: ME, room: ROOM }));
  };

  ws.onmessage = e => {
    const d = JSON.parse(e.data);
    if (d.type === 'history') {
      clearMsgs();
      d.messages.forEach(m => appendMsg(m));
      scrollBottom(true);
      setOverlay(false);
    }
    else if (d.type === 'message') {
      removeEmpty();
      appendMsg(d.msg);
      scrollBottom();
      if (!focused && d.msg.sender !== ME) { unread++; document.title = '('+unread+') inside'; }
    }
    else if (d.type === 'presence') {
      const others = d.online.filter(n => n !== ME);
      const st = document.getElementById('tstatus');
      const dot = document.getElementById('odot');
      if (others.length > 0) {
        st.textContent = others.join(', ') + ' en lÃ­nea';
        st.classList.add('on'); dot.classList.add('on');
      } else {
        st.textContent = 'Sin conexiones activas';
        st.classList.remove('on'); dot.classList.remove('on');
      }
    }
    else if (d.type === 'typing') {
      showTyping(d.active ? d.name : null);
    }
  };

  ws.onclose = () => {
    reconnects++;
    const delay = Math.min(1000 * reconnects, 8000);
    setOverlay(true, 'Sin conexiÃ³n. Reintentando...');
    reconnectTimer = setTimeout(connectWS, delay);
  };

  ws.onerror = () => ws.close();
}

function setOverlay(show, msg='') {
  const o = document.getElementById('overlay');
  const p = document.getElementById('overlay-msg');
  if (msg) p.textContent = msg;
  o.classList.toggle('gone', !show);
}

// â”€â”€ Messages â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function clearMsgs() {
  const c = document.getElementById('msgs');
  c.innerHTML = '<div class="empty" id="empty"><div class="eicon">ðŸ”’</div><p>Solo quien tenga el cÃ³digo puede ver estos mensajes</p></div>';
  lastDate = '';
}

function removeEmpty() {
  const e = document.getElementById('empty');
  if (e) e.remove();
}

function appendMsg(msg) {
  const c = document.getElementById('msgs');
  removeEmpty();
  const isMine = msg.sender === ME;
  const dl = fmtDate(msg.ts);
  if (dl !== lastDate) {
    lastDate = dl;
    const sep = document.createElement('div');
    sep.className = 'dsep';
    sep.innerHTML = '<span>' + dl + '</span>';
    c.appendChild(sep);
  }
  const row = document.createElement('div');
  row.className = 'mrow ' + (isMine ? 'mine' : 'theirs');
  const bub = document.createElement('div');
  bub.className = 'bub';
  if (!isMine) bub.innerHTML = '<span class="bsender">' + safe(msg.sender) + '</span>';
  const txt = document.createElement('span');
  txt.className = 'btext';
  txt.innerHTML = linkify(msg.text);
  bub.appendChild(txt);
  const meta = document.createElement('div');
  meta.className = 'bmeta';
  meta.innerHTML = '<span class="btime">' + fmtTime(msg.ts) + '</span>';
  if (isMine) meta.innerHTML += '<span class="btick"><svg viewBox="0 0 24 24"><path d="M18 7l-1.4-1.4-6.6 6.6-2.6-2.6L6 11l4 4zm-14 5l4 4L20 4l-1.4-1.4L8 14.2l-2.6-2.6z"/></svg></span>';
  bub.appendChild(meta);
  row.appendChild(bub);
  c.appendChild(row);
  requestAnimationFrame(() => row.classList.add('in'));
}

function scrollBottom(force = false) {
  const c = document.getElementById('msgs');
  const near = c.scrollHeight - c.scrollTop - c.clientHeight < 150;
  if (force || near) requestAnimationFrame(() => c.scrollTo({ top: c.scrollHeight, behavior: 'smooth' }));
}

// â”€â”€ Typing â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function showTyping(name) {
  const inner = document.getElementById('tyinner');
  const label = document.getElementById('tylabel');
  if (name) { label.textContent = name + ' estÃ¡ escribiendo...'; inner.classList.add('on'); }
  else { inner.classList.remove('on'); }
}

// â”€â”€ Send â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function sendMsg() {
  const inp = document.getElementById('inp');
  const text = inp.value.trim();
  if (!text || !ws || ws.readyState !== WebSocket.OPEN) return;
  ws.send(JSON.stringify({ type: 'message', text }));
  inp.value = '';
  inp.style.height = 'auto';
  document.getElementById('bsend').classList.remove('on');
  ws.send(JSON.stringify({ type: 'typing', active: false }));
}

// â”€â”€ Input setup â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function setupInput() {
  const inp = document.getElementById('inp');
  const btn = document.getElementById('bsend');
  inp.addEventListener('input', () => {
    inp.style.height = 'auto';
    inp.style.height = Math.min(inp.scrollHeight, 130) + 'px';
    btn.classList.toggle('on', inp.value.trim().length > 0);
    if (ws && ws.readyState === WebSocket.OPEN) {
      ws.send(JSON.stringify({ type: 'typing', active: true }));
      clearTimeout(typingOut);
      typingOut = setTimeout(() => {
        if (ws && ws.readyState === WebSocket.OPEN)
          ws.send(JSON.stringify({ type: 'typing', active: false }));
      }, 3000);
    }
  });
  inp.addEventListener('keydown', e => {
    if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMsg(); }
  });
  inp.focus();
}
</script>
</body>
</html>
